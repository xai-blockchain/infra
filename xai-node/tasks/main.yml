---
# XAI Python-based node deployment

- name: Create daemon user
  ansible.builtin.user:
    name: "{{ daemon_user }}"
    shell: /bin/bash
    create_home: yes
    state: present

- name: Install Python and dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - python3-dev
      - libffi-dev
      - libssl-dev
    state: present

- name: Create XAI directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ daemon_user }}"
    group: "{{ daemon_user }}"
    mode: '0755'
  loop:
    - "{{ daemon_home }}"
    - "{{ daemon_home }}/data"
    - "{{ daemon_home }}/logs"
    - "{{ venv_path }}"

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: "python3 -m venv {{ venv_path }}"
    creates: "{{ venv_path }}/bin/python"
  become: yes
  become_user: "{{ daemon_user }}"

- name: Upgrade pip in virtual environment
  ansible.builtin.pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ venv_path }}"
  become: yes
  become_user: "{{ daemon_user }}"

- name: Install XAI package
  ansible.builtin.pip:
    name: "{{ xai_package | default('.') }}"
    state: present
    virtualenv: "{{ venv_path }}"
    extra_args: "--upgrade"
  become: yes
  become_user: "{{ daemon_user }}"
  when: xai_package is defined
  notify: restart xai service

- name: Configure XAI node
  ansible.builtin.template:
    src: xai-config.yml.j2
    dest: "{{ daemon_home }}/config.yml"
    owner: "{{ daemon_user }}"
    group: "{{ daemon_user }}"
    mode: '0644'
  notify: restart xai service

- name: Create systemd service
  ansible.builtin.template:
    src: xai.service.j2
    dest: "/etc/systemd/system/{{ service_name }}.service"
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart xai service

- name: Allow P2P port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ p2p_port }}"
    proto: tcp

- name: Allow RPC port through UFW
  community.general.ufw:
    rule: allow
    port: "{{ rpc_port }}"
    proto: tcp
    from_ip: "{{ '10.10.0.0/24' if node_type == 'validator' else 'any' }}"

- name: Enable and start XAI service
  ansible.builtin.service:
    name: "{{ service_name }}"
    state: started
    enabled: yes

- name: Wait for node to start
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ rpc_port }}/status"
    return_content: yes
  register: node_status
  until: node_status.status == 200
  retries: 30
  delay: 10
  ignore_errors: yes
