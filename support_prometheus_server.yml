---
# XAI Prometheus Server - Central metrics collection
#
# Deploys Prometheus server to scrape metrics from all XAI nodes and exporters.
# Standard blockchain community pattern for centralized monitoring.
#
# Usage:
#   ansible-playbook -i inventory/testnet.yml support_prometheus_server.yml --limit monitoring
#   ansible-playbook -i inventory/testnet.yml support_prometheus_server.yml -e retention_days=30
#
# Variables:
#   prometheus_version: Prometheus version to install (default: 2.48.0)
#   prometheus_port: Prometheus web port (default: 9090)
#   retention_days: Data retention in days (default: 15)

- name: XAI Prometheus Server Deployment
  hosts: all
  become: true
  gather_facts: true

  vars:
    prometheus_version: "2.48.0"
    prometheus_port: 9090
    prometheus_data_dir: /var/lib/prometheus
    prometheus_config_dir: /etc/prometheus
    retention_days: 15
    scrape_interval: "15s"
    evaluation_interval: "15s"
    vpn_network: "10.10.0.0/24"
    node_exporter_port: 9100
    xai_metrics_port: 9302

  handlers:
    - name: Reload prometheus
      ansible.builtin.service:
        name: prometheus
        state: reloaded

    - name: Restart prometheus
      ansible.builtin.service:
        name: prometheus
        state: restarted

  tasks:
    # =========================================================================
    # Create Prometheus User and Directories
    # =========================================================================
    - name: Create prometheus system user
      ansible.builtin.user:
        name: prometheus
        shell: /usr/sbin/nologin
        create_home: false
        system: true

    - name: Create Prometheus directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: prometheus
        group: prometheus
        mode: '0755'
      loop:
        - "{{ prometheus_config_dir }}"
        - "{{ prometheus_config_dir }}/rules"
        - "{{ prometheus_config_dir }}/targets"
        - "{{ prometheus_data_dir }}"

    # =========================================================================
    # Download and Install Prometheus
    # =========================================================================
    - name: Download Prometheus
      ansible.builtin.get_url:
        url: >-
          https://github.com/prometheus/prometheus/releases/download/v{{
          prometheus_version }}/prometheus-{{
          prometheus_version }}.linux-amd64.tar.gz
        dest: /tmp/prometheus.tar.gz
        mode: '0644'

    - name: Extract Prometheus
      ansible.builtin.unarchive:
        src: /tmp/prometheus.tar.gz
        dest: /opt/
        remote_src: true
        creates: "/opt/prometheus-{{ prometheus_version }}.linux-amd64"

    - name: Create Prometheus symlinks
      ansible.builtin.file:
        src: "/opt/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        state: link
        force: true
      loop:
        - prometheus
        - promtool

    - name: Copy console templates
      ansible.builtin.copy:
        src: "/opt/prometheus-{{ prometheus_version }}.linux-amd64/{{ item }}"
        dest: "{{ prometheus_config_dir }}/{{ item }}"
        remote_src: true
        owner: prometheus
        group: prometheus
        mode: '0755'
      loop:
        - consoles
        - console_libraries

    # =========================================================================
    # Configure Prometheus
    # =========================================================================
    - name: Deploy Prometheus configuration
      ansible.builtin.copy:
        content: |
          # XAI Prometheus Configuration
          # Auto-generated by Ansible

          global:
            scrape_interval: {{ scrape_interval }}
            evaluation_interval: {{ evaluation_interval }}
            external_labels:
              monitor: 'xai-testnet'
              environment: 'testnet'

          # Alertmanager configuration (optional)
          # alerting:
          #   alertmanagers:
          #     - static_configs:
          #         - targets:
          #           - alertmanager:9093

          # Rule files
          rule_files:
            - "rules/*.yml"

          # Scrape configurations
          scrape_configs:
            # Prometheus self-monitoring
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:{{ prometheus_port }}']
                  labels:
                    instance: 'prometheus'

            # XAI Node Exporters (system metrics)
            - job_name: 'node_exporter'
              file_sd_configs:
                - files:
                    - 'targets/node_exporters.yml'
              relabel_configs:
                - source_labels: [__address__]
                  target_label: instance
                  regex: '([^:]+):\d+'
                  replacement: '${1}'

            # XAI Chain Metrics
            - job_name: 'xai_metrics'
              file_sd_configs:
                - files:
                    - 'targets/xai_metrics.yml'
              relabel_configs:
                - source_labels: [__address__]
                  target_label: instance
                  regex: '([^:]+):\d+'
                  replacement: '${1}'

            # XAI RPC Health (direct scrape from nodes)
            - job_name: 'xai_rpc'
              metrics_path: /metrics
              file_sd_configs:
                - files:
                    - 'targets/xai_rpc.yml'
              relabel_configs:
                - source_labels: [__address__]
                  target_label: instance
                  regex: '([^:]+):\d+'
                  replacement: '${1}'
        dest: "{{ prometheus_config_dir }}/prometheus.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Reload prometheus

    # =========================================================================
    # Target Discovery Files
    # =========================================================================
    - name: Deploy node exporter targets
      ansible.builtin.copy:
        content: |
          # Node Exporter Targets
          # System metrics from all XAI servers
          - targets:
              - '10.10.0.3:{{ node_exporter_port }}'  # xai-testnet
              - '10.10.0.4:{{ node_exporter_port }}'  # services-testnet
            labels:
              job: 'node_exporter'
              network: 'xai-mvp-testnet-1'
        dest: "{{ prometheus_config_dir }}/targets/node_exporters.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Reload prometheus

    - name: Deploy XAI metrics targets
      ansible.builtin.copy:
        content: |
          # XAI Chain Metrics Targets
          # Custom blockchain metrics from xai-metrics-exporter
          - targets:
              - '10.10.0.3:{{ xai_metrics_port }}'  # xai-testnet node1/2
            labels:
              job: 'xai_metrics'
              network: 'xai-mvp-testnet-1'
              node_type: 'validator'
        dest: "{{ prometheus_config_dir }}/targets/xai_metrics.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Reload prometheus

    - name: Deploy XAI RPC targets
      ansible.builtin.copy:
        content: |
          # XAI RPC Targets
          # Direct health checks via RPC endpoints
          - targets:
              - '10.10.0.3:12570'  # sentry1
              - '10.10.0.3:12571'  # sentry2
            labels:
              job: 'xai_rpc'
              network: 'xai-mvp-testnet-1'
              node_type: 'sentry'
        dest: "{{ prometheus_config_dir }}/targets/xai_rpc.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Reload prometheus

    # =========================================================================
    # Alert Rules
    # =========================================================================
    - name: Deploy XAI alert rules
      ansible.builtin.copy:
        content: |
          # XAI Alert Rules
          groups:
            - name: xai_alerts
              rules:
                # Node down alert
                - alert: XAINodeDown
                  expr: up{job="xai_metrics"} == 0
                  for: 2m
                  labels:
                    severity: critical
                  annotations:
                    summary: "XAI node {% raw %}{{ $labels.instance }}{% endraw %} is down"
                    description: "Node has been unreachable for more than 2 minutes."

                # Chain stalled alert
                - alert: XAIChainStalled
                  expr: increase(xai_chain_height[5m]) == 0
                  for: 5m
                  labels:
                    severity: critical
                  annotations:
                    summary: "XAI chain appears stalled"
                    description: "No new blocks in the last 5 minutes."

                # Low peer count alert
                - alert: XAILowPeerCount
                  expr: xai_peer_count < 2
                  for: 5m
                  labels:
                    severity: warning
                  annotations:
                    summary: "XAI node {% raw %}{{ $labels.instance }}{% endraw %} has low peer count"
                    description: "Node has fewer than 2 peers for 5 minutes."

                # High CPU usage
                - alert: HighCPUUsage
                  expr: >-
                    100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
                  for: 10m
                  labels:
                    severity: warning
                  annotations:
                    summary: "High CPU usage on {% raw %}{{ $labels.instance }}{% endraw %}"
                    description: "CPU usage above 80% for 10 minutes."

                # High memory usage
                - alert: HighMemoryUsage
                  expr: >-
                    (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
                  for: 10m
                  labels:
                    severity: warning
                  annotations:
                    summary: "High memory usage on {% raw %}{{ $labels.instance }}{% endraw %}"
                    description: "Memory usage above 85% for 10 minutes."

                # Disk space low
                - alert: LowDiskSpace
                  expr: >-
                    (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
                  for: 10m
                  labels:
                    severity: warning
                  annotations:
                    summary: "Low disk space on {% raw %}{{ $labels.instance }}{% endraw %}"
                    description: "Disk usage above 85% for 10 minutes."
        dest: "{{ prometheus_config_dir }}/rules/xai_alerts.yml"
        owner: prometheus
        group: prometheus
        mode: '0644'
      notify: Reload prometheus

    # =========================================================================
    # Systemd Service
    # =========================================================================
    - name: Create Prometheus systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Prometheus Monitoring System
          Documentation=https://prometheus.io/docs/introduction/overview/
          After=network-online.target

          [Service]
          User=prometheus
          Group=prometheus
          Type=simple
          ExecStart=/usr/local/bin/prometheus \
            --config.file={{ prometheus_config_dir }}/prometheus.yml \
            --storage.tsdb.path={{ prometheus_data_dir }} \
            --storage.tsdb.retention.time={{ retention_days }}d \
            --web.listen-address=:{{ prometheus_port }} \
            --web.console.templates={{ prometheus_config_dir }}/consoles \
            --web.console.libraries={{ prometheus_config_dir }}/console_libraries \
            --web.enable-lifecycle \
            --web.enable-admin-api
          ExecReload=/bin/kill -HUP $MAINPID
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/prometheus.service
        owner: root
        group: root
        mode: '0644'
      notify:
        - Restart prometheus

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    # =========================================================================
    # Firewall Configuration
    # =========================================================================
    - name: Allow Prometheus port through UFW (VPN only)
      community.general.ufw:
        rule: allow
        port: "{{ prometheus_port }}"
        proto: tcp
        from_ip: "{{ vpn_network }}"

    # =========================================================================
    # Validate and Start
    # =========================================================================
    - name: Validate Prometheus configuration
      ansible.builtin.command:
        cmd: promtool check config {{ prometheus_config_dir }}/prometheus.yml
      register: promtool_check
      changed_when: false

    - name: Enable and start Prometheus
      ansible.builtin.service:
        name: prometheus
        state: started
        enabled: true

    # =========================================================================
    # Verification
    # =========================================================================
    - name: Wait for Prometheus to start
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ prometheus_port }}/-/healthy"
        status_code: 200
      register: prometheus_health
      until: prometheus_health.status == 200
      retries: 30
      delay: 2
      check_mode: false

    - name: Display Prometheus configuration
      ansible.builtin.debug:
        msg: |
          ============================================
          XAI Prometheus Server Deployed
          ============================================
          Server: {{ inventory_hostname }}
          Version: {{ prometheus_version }}
          Port: {{ prometheus_port }}
          Data Directory: {{ prometheus_data_dir }}
          Retention: {{ retention_days }} days
          ============================================

          Access:
            Local: http://127.0.0.1:{{ prometheus_port }}
            Status: http://127.0.0.1:{{ prometheus_port }}/-/healthy
            Config: http://127.0.0.1:{{ prometheus_port }}/config
            Targets: http://127.0.0.1:{{ prometheus_port }}/targets

          Scrape Jobs:
            - prometheus (self)
            - node_exporter (system metrics)
            - xai_metrics (chain metrics)
            - xai_rpc (RPC health)

          Alert Rules:
            - XAINodeDown
            - XAIChainStalled
            - XAILowPeerCount
            - HighCPUUsage
            - HighMemoryUsage
            - LowDiskSpace

          Query Examples:
            curl 'http://127.0.0.1:{{ prometheus_port }}/api/v1/query?query=up'
            curl 'http://127.0.0.1:{{ prometheus_port }}/api/v1/query?query=xai_chain_height'
          ============================================
