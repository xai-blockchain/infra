---
# XAI Faucet Deployment - Testnet token distribution
#
# Deploys and configures the XAI testnet faucet service for token distribution.
# Includes rate limiting, Cloudflare Turnstile captcha, and monitoring.
#
# Usage:
#   ansible-playbook -i inventory/testnet.yml support_faucet.yml --limit xai_testnet
#   ansible-playbook -i inventory/testnet.yml support_faucet.yml -e faucet_amount=100
#
# Variables:
#   faucet_port: Faucet service port (default: 12081)
#   faucet_amount: Tokens per request (default: 100)
#   rate_limit_hours: Hours between requests per IP (default: 24)
#
# Prerequisites:
#   - Faucet wallet seed in SOPS secrets: secrets/testnet.yaml -> faucet.wallet_seed
#   - Turnstile keys in SOPS secrets: secrets/testnet.yaml -> cloudflare.turnstile_*

- name: XAI Faucet Deployment
  hosts: all
  become: true
  gather_facts: true

  vars:
    faucet_port: 12081
    faucet_amount: 100
    rate_limit_hours: 24
    max_balance_check: 10000
    faucet_domain: "testnet-faucet.xaiblockchain.com"
    faucet_home: "/opt/xai-faucet"
    faucet_user: "{{ daemon_user }}"
    chain_id: "xai-mvp-testnet-1"
    rpc_endpoint: "http://127.0.0.1:12570"

  handlers:
    - name: Restart faucet
      ansible.builtin.service:
        name: xai-faucet
        state: restarted

    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded

  tasks:
    # =========================================================================
    # Prerequisites
    # =========================================================================
    - name: Install system dependencies
      ansible.builtin.apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - nginx
          - sqlite3
        state: present
        update_cache: true

    - name: Create faucet directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ faucet_user }}"
        group: "{{ faucet_user }}"
        mode: '0755'
      loop:
        - "{{ faucet_home }}"
        - "{{ faucet_home }}/data"
        - "{{ faucet_home }}/logs"
        - "{{ faucet_home }}/static"
        - "{{ faucet_home }}/templates"

    # =========================================================================
    # Python Virtual Environment
    # =========================================================================
    - name: Create Python virtual environment
      ansible.builtin.command:
        cmd: "python3 -m venv {{ faucet_home }}/venv"
        creates: "{{ faucet_home }}/venv/bin/python"
      become: true
      become_user: "{{ faucet_user }}"

    - name: Install Python dependencies  # noqa: package-latest
      ansible.builtin.pip:
        name:
          - flask
          - gunicorn
          - requests
          - python-dotenv
          - redis
        state: latest
        virtualenv: "{{ faucet_home }}/venv"
      become: true
      become_user: "{{ faucet_user }}"

    # =========================================================================
    # Faucet Configuration
    # =========================================================================
    - name: Deploy faucet configuration
      ansible.builtin.copy:
        content: |
          # XAI Faucet Configuration
          # Auto-generated by Ansible

          CHAIN_ID={{ chain_id }}
          RPC_ENDPOINT={{ rpc_endpoint }}
          FAUCET_AMOUNT={{ faucet_amount }}
          RATE_LIMIT_HOURS={{ rate_limit_hours }}
          MAX_BALANCE_CHECK={{ max_balance_check }}
          DATABASE_PATH={{ faucet_home }}/data/faucet.db
          LOG_PATH={{ faucet_home }}/logs/faucet.log

          # Turnstile captcha (load from environment or secrets)
          # TURNSTILE_SITE_KEY=<from secrets>
          # TURNSTILE_SECRET_KEY=<from secrets>

          # Faucet wallet (load from environment or secrets)
          # FAUCET_WALLET_SEED=<from secrets>
        dest: "{{ faucet_home }}/.env"
        owner: "{{ faucet_user }}"
        group: "{{ faucet_user }}"
        mode: '0600'
      notify: Restart faucet

    # =========================================================================
    # Faucet Application
    # =========================================================================
    - name: Deploy faucet application
      ansible.builtin.copy:
        content: |
          #!/usr/bin/env python3
          """XAI Testnet Faucet - Token distribution service."""

          import os
          import time
          import sqlite3
          import hashlib
          import logging
          import requests
          from datetime import datetime, timedelta
          from flask import Flask, request, jsonify, render_template_string
          from functools import wraps

          app = Flask(__name__)

          # Configuration
          CHAIN_ID = os.getenv('CHAIN_ID', 'xai-mvp-testnet-1')
          RPC_ENDPOINT = os.getenv('RPC_ENDPOINT', 'http://127.0.0.1:12570')
          FAUCET_AMOUNT = int(os.getenv('FAUCET_AMOUNT', '100'))
          RATE_LIMIT_HOURS = int(os.getenv('RATE_LIMIT_HOURS', '24'))
          MAX_BALANCE_CHECK = int(os.getenv('MAX_BALANCE_CHECK', '10000'))
          DATABASE_PATH = os.getenv('DATABASE_PATH', 'faucet.db')
          TURNSTILE_SITE_KEY = os.getenv('TURNSTILE_SITE_KEY', '')
          TURNSTILE_SECRET_KEY = os.getenv('TURNSTILE_SECRET_KEY', '')

          # Logging
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(levelname)s - %(message)s'
          )
          logger = logging.getLogger(__name__)

          def init_db():
              """Initialize SQLite database."""
              conn = sqlite3.connect(DATABASE_PATH)
              c = conn.cursor()
              c.execute('''
                  CREATE TABLE IF NOT EXISTS requests (
                      id INTEGER PRIMARY KEY AUTOINCREMENT,
                      ip_hash TEXT NOT NULL,
                      address TEXT NOT NULL,
                      amount INTEGER NOT NULL,
                      tx_hash TEXT,
                      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
                  )
              ''')
              c.execute('CREATE INDEX IF NOT EXISTS idx_ip_hash ON requests(ip_hash)')
              c.execute('CREATE INDEX IF NOT EXISTS idx_address ON requests(address)')
              conn.commit()
              conn.close()

          def get_ip_hash(ip):
              """Hash IP for privacy."""
              return hashlib.sha256(ip.encode()).hexdigest()[:16]

          def check_rate_limit(ip_hash, address):
              """Check if request is rate limited."""
              conn = sqlite3.connect(DATABASE_PATH)
              c = conn.cursor()
              cutoff = datetime.now() - timedelta(hours=RATE_LIMIT_HOURS)

              # Check IP limit
              c.execute(
                  'SELECT COUNT(*) FROM requests WHERE ip_hash = ? AND timestamp > ?',
                  (ip_hash, cutoff)
              )
              if c.fetchone()[0] > 0:
                  conn.close()
                  return True, 'IP rate limited'

              # Check address limit
              c.execute(
                  'SELECT COUNT(*) FROM requests WHERE address = ? AND timestamp > ?',
                  (address, cutoff)
              )
              if c.fetchone()[0] > 0:
                  conn.close()
                  return True, 'Address rate limited'

              conn.close()
              return False, None

          def record_request(ip_hash, address, amount, tx_hash=None):
              """Record faucet request."""
              conn = sqlite3.connect(DATABASE_PATH)
              c = conn.cursor()
              c.execute(
                  'INSERT INTO requests (ip_hash, address, amount, tx_hash) VALUES (?, ?, ?, ?)',
                  (ip_hash, address, amount, tx_hash)
              )
              conn.commit()
              conn.close()

          def verify_turnstile(token):
              """Verify Cloudflare Turnstile token."""
              if not TURNSTILE_SECRET_KEY:
                  return True  # Skip if not configured

              try:
                  response = requests.post(
                      'https://challenges.cloudflare.com/turnstile/v0/siteverify',
                      data={
                          'secret': TURNSTILE_SECRET_KEY,
                          'response': token
                      },
                      timeout=10
                  )
                  return response.json().get('success', False)
              except Exception as e:
                  logger.error(f"Turnstile verification failed: {e}")
                  return False

          def send_tokens(address, amount):
              """Send tokens via XAI RPC."""
              try:
                  response = requests.post(
                      f"{RPC_ENDPOINT}/faucet/send",
                      json={'address': address, 'amount': amount},
                      timeout=30
                  )
                  if response.status_code == 200:
                      return True, response.json().get('tx_hash', 'unknown')
                  return False, response.text
              except Exception as e:
                  logger.error(f"Failed to send tokens: {e}")
                  return False, str(e)

          @app.route('/')
          def index():
              """Faucet homepage."""
              return render_template_string('''
              <!DOCTYPE html>
              <html>
              <head>
                  <title>XAI Testnet Faucet</title>
                  <meta name="viewport" content="width=device-width, initial-scale=1">
                  <style>
                      body { font-family: system-ui; max-width: 600px; margin: 50px auto; padding: 20px; }
                      h1 { color: #333; }
                      .form-group { margin: 20px 0; }
                      input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
                      button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
                      button:hover { background: #45a049; }
                      .info { background: #f0f0f0; padding: 15px; border-radius: 4px; margin: 20px 0; }
                      .error { color: #d32f2f; }
                      .success { color: #388e3c; }
                  </style>
              </head>
              <body>
                  <h1>XAI Testnet Faucet</h1>
                  <div class="info">
                      <p><strong>Network:</strong> {% raw %}{{ chain_id }}{% endraw %}</p>
                      <p><strong>Amount:</strong> {% raw %}{{ amount }}{% endraw %} XAI per request</p>
                      <p><strong>Rate Limit:</strong> Once per {% raw %}{{ hours }}{% endraw %} hours</p>
                  </div>
                  <form id="faucet-form">
                      <div class="form-group">
                          <input type="text" name="address" placeholder="Enter your XAI address" required>
                      </div>
                      <button type="submit">Request Tokens</button>
                  </form>
                  <div id="result"></div>
                  <script>
                      document.getElementById('faucet-form').addEventListener('submit', async (e) => {
                          e.preventDefault();
                          const address = e.target.address.value;
                          const result = document.getElementById('result');
                          result.innerHTML = 'Processing...';
                          try {
                              const response = await fetch('/api/request', {
                                  method: 'POST',
                                  headers: {'Content-Type': 'application/json'},
                                  body: JSON.stringify({address})
                              });
                              const data = await response.json();
                              if (data.success) {
                                  result.innerHTML = '<p class="success">Tokens sent! TX: ' + data.tx_hash + '</p>';
                              } else {
                                  result.innerHTML = '<p class="error">' + data.error + '</p>';
                              }
                          } catch (err) {
                              result.innerHTML = '<p class="error">Request failed</p>';
                          }
                      });
                  </script>
              </body>
              </html>
              ''', chain_id=CHAIN_ID, amount=FAUCET_AMOUNT, hours=RATE_LIMIT_HOURS)

          @app.route('/api/request', methods=['POST'])
          def api_request():
              """Handle faucet request."""
              data = request.get_json()
              address = data.get('address', '').strip()
              captcha_token = data.get('captcha_token', '')

              # Validate address
              if not address:
                  return jsonify({'success': False, 'error': 'Address required'}), 400

              # Get client IP
              client_ip = request.headers.get('X-Forwarded-For', request.remote_addr)
              if ',' in client_ip:
                  client_ip = client_ip.split(',')[0].strip()
              ip_hash = get_ip_hash(client_ip)

              # Check rate limit
              limited, reason = check_rate_limit(ip_hash, address)
              if limited:
                  return jsonify({'success': False, 'error': reason}), 429

              # Verify captcha
              if TURNSTILE_SECRET_KEY and not verify_turnstile(captcha_token):
                  return jsonify({'success': False, 'error': 'Captcha verification failed'}), 400

              # Send tokens
              success, result = send_tokens(address, FAUCET_AMOUNT)
              if success:
                  record_request(ip_hash, address, FAUCET_AMOUNT, result)
                  logger.info(f"Sent {FAUCET_AMOUNT} XAI to {address}")
                  return jsonify({'success': True, 'tx_hash': result, 'amount': FAUCET_AMOUNT})
              else:
                  logger.error(f"Failed to send to {address}: {result}")
                  return jsonify({'success': False, 'error': 'Transaction failed'}), 500

          @app.route('/api/status')
          def api_status():
              """Faucet status endpoint."""
              try:
                  response = requests.get(f"{RPC_ENDPOINT}/stats", timeout=5)
                  node_status = response.json() if response.status_code == 200 else {}
              except Exception:
                  node_status = {}

              return jsonify({
                  'chain_id': CHAIN_ID,
                  'faucet_amount': FAUCET_AMOUNT,
                  'rate_limit_hours': RATE_LIMIT_HOURS,
                  'node_height': node_status.get('chain_height', 'unknown'),
                  'status': 'operational'
              })

          @app.route('/health')
          def health():
              """Health check endpoint."""
              return jsonify({'status': 'ok'})

          if __name__ == '__main__':
              init_db()
              app.run(host='0.0.0.0', port=int(os.getenv('PORT', '12081')))
        dest: "{{ faucet_home }}/app.py"
        owner: "{{ faucet_user }}"
        group: "{{ faucet_user }}"
        mode: '0755'
      notify: Restart faucet

    # =========================================================================
    # Systemd Service
    # =========================================================================
    - name: Create faucet systemd service
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=XAI Testnet Faucet
          After=network.target

          [Service]
          User={{ faucet_user }}
          WorkingDirectory={{ faucet_home }}
          Environment=PATH={{ faucet_home }}/venv/bin:/usr/bin
          EnvironmentFile={{ faucet_home }}/.env
          ExecStart={{ faucet_home }}/venv/bin/gunicorn \
            --bind 127.0.0.1:{{ faucet_port }} \
            --workers 2 \
            --timeout 60 \
            --access-logfile {{ faucet_home }}/logs/access.log \
            --error-logfile {{ faucet_home }}/logs/error.log \
            app:app
          Restart=on-failure
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/xai-faucet.service
        owner: root
        group: root
        mode: '0644'
      notify: Restart faucet

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    # =========================================================================
    # Nginx Configuration
    # =========================================================================
    - name: Deploy faucet nginx configuration
      ansible.builtin.copy:
        content: |
          # XAI Faucet - {{ faucet_domain }}
          server {
              listen 80;
              server_name {{ faucet_domain }};

              access_log /var/log/nginx/faucet-access.log;
              error_log /var/log/nginx/faucet-error.log;

              # Rate limiting
              limit_req_zone $binary_remote_addr zone=faucet_limit:10m rate=10r/m;

              location / {
                  limit_req zone=faucet_limit burst=5 nodelay;

                  proxy_pass http://127.0.0.1:{{ faucet_port }};
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  proxy_connect_timeout 10s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }

              location /health {
                  access_log off;
                  proxy_pass http://127.0.0.1:{{ faucet_port }}/health;
              }
          }
        dest: /etc/nginx/sites-available/xai-faucet.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload nginx

    - name: Enable faucet nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/xai-faucet.conf
        dest: /etc/nginx/sites-enabled/xai-faucet.conf
        state: link
      notify: Reload nginx

    # =========================================================================
    # Firewall
    # =========================================================================
    - name: Allow faucet port through UFW (localhost only)
      community.general.ufw:
        rule: allow
        port: "{{ faucet_port }}"
        proto: tcp
        from_ip: 127.0.0.1

    # =========================================================================
    # Enable and Start
    # =========================================================================
    - name: Enable and start faucet service
      ansible.builtin.service:
        name: xai-faucet
        state: started
        enabled: true

    # =========================================================================
    # Verification
    # =========================================================================
    - name: Wait for faucet to start
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ faucet_port }}/health"
        status_code: 200
      register: faucet_health
      until: faucet_health.status == 200
      retries: 30
      delay: 2
      check_mode: false

    - name: Display faucet configuration
      ansible.builtin.debug:
        msg: |
          ============================================
          XAI Faucet Deployed
          ============================================
          Server: {{ inventory_hostname }}
          Port: {{ faucet_port }}
          Domain: {{ faucet_domain }}
          ============================================

          Configuration:
            Amount per request: {{ faucet_amount }} XAI
            Rate limit: {{ rate_limit_hours }} hours
            Max balance check: {{ max_balance_check }} XAI
            RPC endpoint: {{ rpc_endpoint }}

          Access:
            Local: http://127.0.0.1:{{ faucet_port }}
            Public: https://{{ faucet_domain }}
            Status: https://{{ faucet_domain }}/api/status

          Logs:
            Access: {{ faucet_home }}/logs/access.log
            Error: {{ faucet_home }}/logs/error.log

          Database:
            {{ faucet_home }}/data/faucet.db
          ============================================

          IMPORTANT: Configure secrets in {{ faucet_home }}/.env:
            - FAUCET_WALLET_SEED (from SOPS)
            - TURNSTILE_SITE_KEY (from SOPS)
            - TURNSTILE_SECRET_KEY (from SOPS)
          ============================================
